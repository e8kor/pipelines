#!/bin/bash

read -p "Should install linkerd2? [Y/n]" -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
    echo 'start linkerd installation'
    if ! [ -x "$(command -v linkerd2)" ]; then
        echo 'linkerd2 is not installed.'
        arkade get linkerd2
    fi

    echo 'installing linkerd'
    arkade install linkerd

    echo 'installing linkerd-injection'
    kubectl -n openfaas get deploy gateway -o yaml | linkerd inject --skip-outbound-ports=4222 - | kubectl apply -f - \
        && kubectl -n openfaas get deploy/basic-auth-plugin -o yaml | linkerd inject - | kubectl apply -f - \
        && kubectl -n openfaas get deploy/faas-idler -o yaml | linkerd inject - | kubectl apply -f -  \
        && kubectl -n openfaas get deploy/queue-worker -o yaml | linkerd inject  --skip-outbound-ports=4222 - | kubectl apply -f - \
        && kubectl annotate namespace openfaas-fn linkerd.io/inject=enabled  \
        && kubectl -n openfaas-fn get deploy -o yaml | linkerd inject - | kubectl apply -f -
fi
